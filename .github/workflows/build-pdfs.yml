name: Build PDFs

on:
  push:
    paths:
      - "tex/**"
      - ".github/workflows/build-pdfs.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build modernism.tex (pLaTeX + dvipdfmx)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: modernism.tex
          working_directory: tex
          compiler: latexmk
          args: -pdfdvi -interaction=nonstopmode -halt-on-error -file-line-error

      - name: Check outputs (always)
        if: always()
        run: |
          echo "===== tex contents ====="
          ls -la tex
          test -f tex/modernism.dvi && echo "DVI exists" || echo "DVI missing"
          test -f tex/modernism.pdf && echo "PDF exists" || echo "PDF missing"

      - name: Debug logs (always)
        if: always()
        run: |
          echo "===== tail modernism.log ====="
          tail -n 200 tex/modernism.log || true

      - name: Run dvipdfmx directly (always)
        if: always()
        run: |
          set -euxo pipefail
          cd tex
          dvipdfmx -vv -o modernism.pdf modernism.dvi || true
          ls -la
          test -f modernism.pdf && echo "PDF generated by dvipdfmx" || echo "PDF still missing"

      - name: Move PDF into pdfs/
        if: success()
        run: |
          mkdir -p pdfs
          mv "tex/modernism.pdf" "pdfs/modernism.pdf"

      - name: Commit updated PDF
        if: success()
        uses: EndBug/add-and-commit@v9
        with:
          add: "pdfs/modernism.pdf"
          message: "Auto-build modernism.pdf"
          default_author: github_actions


